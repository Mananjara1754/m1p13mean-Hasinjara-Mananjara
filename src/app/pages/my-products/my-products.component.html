<div class="header-actions">
  <h2>My Products ({{ totalItems }})</h2>
  <button class="btn-primary" (click)="openModal()">+ Add Product</button>
</div>

<div class="loading-spinner" *ngIf="isLoading && products.length === 0">
  <div class="spinner"></div>
  <p>Loading products...</p>
</div>

<div class="empty-state" *ngIf="!isLoading && products.length === 0">
  <p>No products found.</p>
</div>

<div class="card-grid" [class.opacity-50]="isLoading && products.length > 0">
  <div class="card" *ngFor="let product of products">
    <div class="card-image">
      <img *ngIf="product.images && product.images.length" [src]="product.images[0]" alt="{{ product.name }}">
      <div class="no-image" *ngIf="!product.images || !product.images.length">
        <span>No Image</span>
      </div>
    </div>
    <div class="card-header">
      <h3>{{ product.name }}</h3>
      <span class="price">{{ formatNumber(product.price.current) }} {{ product.price.currency }}</span>
    </div>
    <div class="card-body">
      <p>{{ product.description }}</p>
      <div class="stock-badge" [class.low-stock]="product.stock.quantity <= 10 && product.stock.quantity > 0"
        [class.out-of-stock]="product.stock.quantity === 0">
        Stock: {{ formatNumber(product.stock.quantity) }}
      </div>
      <p *ngIf="product.category_id" class="category-text">Category: {{ getCategoryName(product.category_id) }}</p>
    </div>
    <div class="card-footer">
      <button class="btn-icon" (click)="showProductDetails(product)" title="View Details">
        <img src="assets/image/icons/ic_eye.svg" alt="View">
      </button>
      <button class="btn-icon" (click)="editProduct(product)" title="Edit">
        <img src="assets/image/icons/ic_edit.svg" alt="Edit">
      </button>
      <button class="btn-icon btn-danger" (click)="deleteProduct(product._id)" title="Delete">
        <img src="assets/image/icons/ic_delete.svg" alt="Delete">
      </button>
    </div>
  </div>
</div>

<app-pagination *ngIf="products.length > 0" [currentPage]="currentPage" [totalPages]="totalPages"
  [totalItems]="totalItems" [limit]="limit" (pageChange)="onPageChange($event)">
</app-pagination>

<div class="modal" *ngIf="showModal">
  <div class="modal-content">
    <h3>{{ isEditing ? 'Edit' : 'Add' }} Product</h3>
    <form (ngSubmit)="saveProduct()">
      <div class="form-group">
        <label>Name</label>
        <input type="text" [(ngModel)]="currentProduct.name" name="name" required>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea [(ngModel)]="currentProduct.description" name="description"></textarea>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select [(ngModel)]="currentProduct.category_id" name="category_id" class="form-control">
          <option value="">Select Category</option>
          <option *ngFor="let category of categories" [value]="category._id">
            {{ category.name }}
          </option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group half">
          <label>Price</label>
          <input type="number" [(ngModel)]="currentProduct.price.current" name="price" required min="0">
        </div>
        <div class="form-group half">
          <label>Currency</label>
          <input type="text" [(ngModel)]="currentProduct.price.currency" name="currency" readonly>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group half">
          <label>Stock Quantity</label>
          <input type="number" [(ngModel)]="currentProduct.stock.quantity" name="stock" required min="0">
        </div>
        <div class="form-group half">
          <label>Status</label>
          <select [(ngModel)]="currentProduct.stock.status" name="status">
            <option value="in_stock">In Stock</option>
            <option value="low_stock">Low Stock</option>
            <option value="out_of_stock">Out of Stock</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Images (Max 5)</label>
        <input type="file" multiple (change)="onFileSelected($event)" accept="image/*">
        <div class="image-previews" *ngIf="isEditing && currentProduct.images && currentProduct.images.length">
          <p>Current Images:</p>
          <div class="preview-grid">
            <img *ngFor="let img of currentProduct.images" [src]="img" class="mini-preview">
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="isLoading">
          {{ isLoading ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Product Details Modal -->
<div class="modal" *ngIf="showDetailsModal">
  <div class="modal-content modal-xl">
    <div class="modal-header">
      <h3>{{ selectedProduct?.name }}</h3>
      <button type="button" class="close" (click)="closeDetailsModal()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="selectedProduct">
      <div class="product-details">
        <div class="images-section">
          <div class="main-image" *ngIf="selectedProduct.images && selectedProduct.images.length > 0">
            <img [src]="selectedProduct.images[0]" alt="{{ selectedProduct.name }}">
          </div>
          <div class="thumbnails" *ngIf="selectedProduct.images && selectedProduct.images.length > 1">
            <img *ngFor="let image of selectedProduct.images.slice(1)" [src]="image" alt="{{ selectedProduct.name }}">
          </div>
        </div>

        <div class="info-section">
          <div class="info-item">
            <strong>Description:</strong>
            <p>{{ selectedProduct.description || 'No description available' }}</p>
          </div>

          <div class="info-item">
            <strong>Price:</strong>
            <span class="price">{{ formatNumber(selectedProduct.price.current) }} {{ selectedProduct.price.currency
              }}</span>
          </div>

          <div class="info-item">
            <strong>Stock:</strong>
            <span
              [ngClass]="{'text-success': selectedProduct.stock.quantity > 10, 'text-warning': selectedProduct.stock.quantity <= 10 && selectedProduct.stock.quantity > 0, 'text-danger': selectedProduct.stock.quantity === 0}">
              {{ formatNumber(selectedProduct.stock.quantity) }} ({{ selectedProduct.stock.status }})
            </span>
          </div>

          <div class="info-item" *ngIf="selectedProduct.category_id">
            <strong>Category:</strong>
            <span>{{ getCategoryName(selectedProduct.category_id) }}</span>
          </div>

          <div class="info-item" *ngIf="selectedProduct.promotion && selectedProduct.promotion.is_active">
            <strong>Promotion:</strong>
            <span class="promotion">{{ selectedProduct.promotion.discount_percent }}% OFF</span>
            <small *ngIf="selectedProduct.promotion.start_date && selectedProduct.promotion.end_date">
              ({{ selectedProduct.promotion.start_date | date:'short' }} - {{ selectedProduct.promotion.end_date |
              date:'short' }})
            </small>
          </div>
        </div>

        <div class="price-history-section"
          *ngIf="selectedProduct.price_history && selectedProduct.price_history.length > 0">
          <h4>Price History</h4>
          <div class="price-chart">
            <canvas id="priceHistoryChart"></canvas>
          </div>
          <div class="no-chart" *ngIf="selectedProduct.price_history.length < 2">
            <p>Not enough data for chart.</p>
          </div>
          <div class="price-history-list">
            <div *ngFor="let history of selectedProduct.price_history" class="history-item">
              <span>{{ formatNumber(history.price) }} {{ selectedProduct.price.currency }}</span>
              <small>{{ history.from | date:'short' }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeDetailsModal()">Close</button>
    </div>
  </div>
</div>